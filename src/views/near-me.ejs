<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dispensaries Near Me - Find Cannabis Dispensaries Nearby</title>
  <meta name="description" content="Find the best cannabis dispensaries near your location. Use your device's GPS to discover top-rated dispensaries within miles of you.">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=<%= process.env.GOOGLE_PLACES_API_KEY %>&callback=initNearMeMap"></script>
  <style>body { font-family: 'Inter', sans-serif; }</style>
</head>
<body class="bg-gray-50">
  <%- include('partials/header') %>

  <main class="container mx-auto px-4 py-8">
    <!-- Hero Section -->
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold mb-4">Dispensaries Near You</h1>
      <p class="text-xl text-gray-600 mb-6">Find the best cannabis dispensaries within miles of your location</p>

      <button id="get-location-btn" class="bg-green-600 text-white font-bold px-8 py-3 rounded-lg hover:bg-green-700 transition">
        <span class="flex items-center gap-2">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
          </svg>
          Use My Location
        </span>
      </button>

      <div id="location-status" class="mt-4 text-sm"></div>
    </div>

    <!-- Radius Filter -->
    <div id="filters" class="hidden mb-6 bg-white rounded-lg shadow p-4">
      <div class="flex items-center gap-4">
        <label class="font-medium text-gray-700">Search Radius:</label>
        <select id="radius-select" class="px-4 py-2 border border-gray-300 rounded-lg">
          <option value="5">5 miles</option>
          <option value="10" selected>10 miles</option>
          <option value="25">25 miles</option>
          <option value="50">50 miles</option>
          <option value="100">100 miles</option>
        </select>
      </div>
    </div>

    <!-- Map -->
    <div id="map-container" class="hidden mb-8">
      <div id="near-me-map" class="w-full h-96 rounded-lg shadow-lg"></div>
    </div>

    <!-- Results -->
    <div id="results-container" class="hidden">
      <h2 class="text-2xl font-bold mb-6">
        <span id="results-count">0</span> Dispensaries Found
      </h2>
      <div id="results-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Results will be populated here -->
      </div>
    </div>

    <!-- No Results -->
    <div id="no-results" class="hidden text-center py-12">
      <p class="text-xl text-gray-600">No dispensaries found within the selected radius</p>
      <p class="text-sm text-gray-500 mt-2">Try increasing the search radius</p>
    </div>
  </main>

  <%- include('partials/footer') %>
  <script src="/js/main.js"></script>
  <script src="/js/map.js"></script>
  <script>
    let nearbyDispensaries = [];
    let currentRadius = 10;
    let userLat, userLng;
    let map;

    document.getElementById('get-location-btn').addEventListener('click', findNearbyDispensaries);
    document.getElementById('radius-select').addEventListener('change', (e) => {
      currentRadius = parseInt(e.target.value);
      if (userLat && userLng) {
        findNearbyDispensaries();
      }
    });

    async function findNearbyDispensaries() {
      const btn = document.getElementById('get-location-btn');
      const statusEl = document.getElementById('location-status');

      btn.disabled = true;
      btn.innerHTML = '<span class="flex items-center gap-2"><svg class="animate-spin h-5 w-5" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Getting your location...</span>';

      try {
        const location = await getUserLocation();
        userLat = location.lat;
        userLng = location.lng;

        statusEl.innerHTML = '<span class="text-green-600">Location found! Searching nearby dispensaries...</span>';

        // Fetch all dispensaries
        const response = await fetch('/api/dispensaries/all');
        const data = await response.json();

        // Calculate distances and filter by radius
        nearbyDispensaries = data.dispensaries
          .filter(d => d.lat && d.lng)
          .map(d => ({
            ...d,
            distance: calculateDistance(userLat, userLng, parseFloat(d.lat), parseFloat(d.lng))
          }))
          .filter(d => d.distance <= currentRadius)
          .sort((a, b) => a.distance - b.distance);

        displayResults(nearbyDispensaries);
        showMap(nearbyDispensaries);

        btn.innerHTML = '<span class="flex items-center gap-2"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/></svg>Refresh Location</span>';
        btn.disabled = false;

        document.getElementById('filters').classList.remove('hidden');

      } catch (error) {
        console.error('Error:', error);
        statusEl.innerHTML = '<span class="text-red-600">Unable to get your location. Please enable location services.</span>';
        btn.innerHTML = '<span class="flex items-center gap-2"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/></svg>Try Again</span>';
        btn.disabled = false;
      }
    }

    function displayResults(dispensaries) {
      const container = document.getElementById('results-list');
      const countEl = document.getElementById('results-count');

      container.innerHTML = '';
      countEl.textContent = dispensaries.length;

      if (dispensaries.length === 0) {
        document.getElementById('no-results').classList.remove('hidden');
        document.getElementById('results-container').classList.add('hidden');
        return;
      }

      document.getElementById('no-results').classList.add('hidden');
      document.getElementById('results-container').classList.remove('hidden');

      dispensaries.forEach(disp => {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition';

        card.innerHTML = `
          <div class="flex items-start justify-between mb-3">
            <div class="flex-1">
              <h3 class="text-lg font-bold mb-1">
                <a href="/dispensary/${disp.slug}" class="hover:text-green-600">${disp.name}</a>
              </h3>
              <p class="text-sm text-gray-600">${disp.city}, ${disp.state_name || ''}</p>
            </div>
            <div class="text-right">
              <div class="text-green-600 font-bold">${disp.distance.toFixed(1)} mi</div>
            </div>
          </div>

          ${disp.google_rating ? `
            <div class="flex items-center gap-2 mb-3">
              <span class="text-yellow-500">★</span>
              <span class="font-semibold">${Number(disp.google_rating).toFixed(1)}/5</span>
              ${disp.google_review_count ? `<span class="text-sm text-gray-500">(${disp.google_review_count})</span>` : ''}
            </div>
          ` : ''}

          <div class="flex gap-2">
            <a href="/dispensary/${disp.slug}" class="flex-1 text-center bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm font-medium">
              View Details
            </a>
            <a href="https://www.google.com/maps/dir/?api=1&destination=${disp.lat},${disp.lng}"
               target="_blank"
               class="flex-1 text-center bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm font-medium">
              Directions
            </a>
          </div>
        `;

        container.appendChild(card);
      });
    }

    function showMap(dispensaries) {
      document.getElementById('map-container').classList.remove('hidden');

      const mapContainer = document.getElementById('near-me-map');

      map = new google.maps.Map(mapContainer, {
        center: { lat: userLat, lng: userLng },
        zoom: 11
      });

      // Add user location marker
      new google.maps.Marker({
        position: { lat: userLat, lng: userLng },
        map,
        title: 'Your Location',
        icon: {
          url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
            <svg width="30" height="30" viewBox="0 0 30 30" xmlns="http://www.w3.org/2000/svg">
              <circle cx="15" cy="15" r="12" fill="#3b82f6" stroke="white" stroke-width="3"/>
              <circle cx="15" cy="15" r="4" fill="white"/>
            </svg>
          `),
          scaledSize: new google.maps.Size(30, 30)
        }
      });

      // Add dispensary markers
      const infoWindow = new google.maps.InfoWindow();

      dispensaries.forEach(disp => {
        const marker = new google.maps.Marker({
          position: { lat: parseFloat(disp.lat), lng: parseFloat(disp.lng) },
          map,
          title: disp.name,
          icon: {
            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
              <svg width="30" height="40" viewBox="0 0 30 40" xmlns="http://www.w3.org/2000/svg">
                <path d="M15 0C7 0 0 7 0 15c0 11 15 25 15 25s15-14 15-25C30 7 23 0 15 0z" fill="#16a34a"/>
                <circle cx="15" cy="15" r="6" fill="white"/>
              </svg>
            `),
            scaledSize: new google.maps.Size(30, 40)
          }
        });

        marker.addListener('click', () => {
          const rating = disp.google_rating ? `⭐ ${disp.google_rating}/5` : '';
          infoWindow.setContent(`
            <div class="p-3" style="min-width: 200px;">
              <h3 class="font-bold text-base mb-1">${disp.name}</h3>
              ${rating ? `<div class="text-sm text-gray-600 mb-2">${rating}</div>` : ''}
              <p class="text-sm text-gray-600 mb-2">${disp.distance.toFixed(1)} miles away</p>
              <div class="flex gap-2">
                <a href="/dispensary/${disp.slug}" class="inline-block bg-green-600 text-white px-3 py-1 rounded text-sm">
                  View Details
                </a>
                <a href="https://www.google.com/maps/dir/?api=1&destination=${disp.lat},${disp.lng}"
                   target="_blank" class="inline-block bg-blue-600 text-white px-3 py-1 rounded text-sm">
                  Directions
                </a>
              </div>
            </div>
          `);
          infoWindow.open(map, marker);
        });
      });
    }

    function initNearMeMap() {
      // Callback for Google Maps API
      console.log('Google Maps loaded');
    }
  </script>
</body>
</html>
