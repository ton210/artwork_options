<div id="review-form-section" class="bg-white rounded-lg shadow-lg p-6 mb-8">
  <h3 class="text-2xl font-bold mb-4">Write a Review</h3>

  <div id="review-eligibility-message" class="hidden mb-4"></div>

  <!-- reCAPTCHA Script -->
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>

  <form id="review-form" class="space-y-4">
    <!-- Star Rating -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">
        Your Rating <span class="text-red-500">*</span>
      </label>
      <div class="flex gap-2" id="star-rating">
        <button type="button" class="star-btn text-3xl text-gray-300 hover:text-yellow-400 transition" data-rating="1">★</button>
        <button type="button" class="star-btn text-3xl text-gray-300 hover:text-yellow-400 transition" data-rating="2">★</button>
        <button type="button" class="star-btn text-3xl text-gray-300 hover:text-yellow-400 transition" data-rating="3">★</button>
        <button type="button" class="star-btn text-3xl text-gray-300 hover:text-yellow-400 transition" data-rating="4">★</button>
        <button type="button" class="star-btn text-3xl text-gray-300 hover:text-yellow-400 transition" data-rating="5">★</button>
      </div>
      <input type="hidden" id="rating-value" name="rating" required>
    </div>

    <!-- Name -->
    <div>
      <label for="author-name" class="block text-sm font-medium text-gray-700 mb-2">
        Your Name <span class="text-red-500">*</span>
      </label>
      <input
        type="text"
        id="author-name"
        name="authorName"
        required
        maxlength="100"
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
        placeholder="John Doe"
      >
    </div>

    <!-- Email (optional) -->
    <div>
      <label for="author-email" class="block text-sm font-medium text-gray-700 mb-2">
        Email (optional, for verification)
      </label>
      <input
        type="email"
        id="author-email"
        name="authorEmail"
        maxlength="255"
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
        placeholder="you@example.com"
      >
      <p class="text-xs text-gray-500 mt-1">Your email will not be displayed publicly</p>
    </div>

    <!-- Review Text -->
    <div>
      <label for="review-text" class="block text-sm font-medium text-gray-700 mb-2">
        Your Review <span class="text-red-500">*</span>
      </label>
      <textarea
        id="review-text"
        name="reviewText"
        required
        minlength="50"
        maxlength="1000"
        rows="5"
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
        placeholder="Share your experience with this dispensary... (minimum 50 characters)"
      ></textarea>
      <div class="flex justify-between text-xs text-gray-500 mt-1">
        <span id="char-counter">0 / 1000 characters</span>
        <span id="char-minimum" class="text-red-500 hidden">Minimum 50 characters required</span>
      </div>
    </div>

    <!-- reCAPTCHA -->
    <div>
      <div class="g-recaptcha" data-sitekey="6Lcc5TYsAAAAADRpPU3QhEib2x7Fr6Rz-NI8r0sg"></div>
    </div>

    <!-- Submit Button -->
    <div>
      <button
        type="submit"
        id="submit-review-btn"
        class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed"
      >
        Submit Review
      </button>
    </div>

    <!-- Success/Error Messages -->
    <div id="review-message" class="hidden p-4 rounded-lg"></div>
  </form>
</div>

<script>
(function() {
  const dispensaryId = <%= dispensary.id %>;
  let selectedRating = 0;

  // Check if user can review
  async function checkEligibility() {
    try {
      const response = await fetch(`/api/reviews/can-review/${dispensaryId}`);
      const data = await response.json();

      if (!data.canReview) {
        const message = document.getElementById('review-eligibility-message');
        message.className = 'p-4 bg-yellow-100 border border-yellow-400 text-yellow-800 rounded-lg mb-4';

        if (data.reason === 'already_reviewed') {
          message.textContent = 'You have already submitted a review for this dispensary.';
        } else if (data.reason === 'rate_limit') {
          message.textContent = 'You have reached the daily review limit (3 reviews per day).';
        }

        message.classList.remove('hidden');
        document.getElementById('review-form').style.display = 'none';
      }
    } catch (error) {
      console.error('Error checking eligibility:', error);
    }
  }

  checkEligibility();

  // Star rating functionality
  const starButtons = document.querySelectorAll('.star-btn');
  const ratingValue = document.getElementById('rating-value');

  starButtons.forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      selectedRating = parseInt(btn.dataset.rating);
      ratingValue.value = selectedRating;

      starButtons.forEach((star, index) => {
        if (index < selectedRating) {
          star.classList.remove('text-gray-300');
          star.classList.add('text-yellow-400');
        } else {
          star.classList.remove('text-yellow-400');
          star.classList.add('text-gray-300');
        }
      });
    });
  });

  // Character counter
  const reviewText = document.getElementById('review-text');
  const charCounter = document.getElementById('char-counter');
  const charMinimum = document.getElementById('char-minimum');

  reviewText.addEventListener('input', () => {
    const length = reviewText.value.length;
    charCounter.textContent = `${length} / 1000 characters`;

    if (length < 50) {
      charMinimum.classList.remove('hidden');
    } else {
      charMinimum.classList.add('hidden');
    }
  });

  // Form submission
  const form = document.getElementById('review-form');
  const submitBtn = document.getElementById('submit-review-btn');
  const messageDiv = document.getElementById('review-message');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (selectedRating === 0) {
      showMessage('Please select a star rating', 'error');
      return;
    }

    if (reviewText.value.length < 50) {
      showMessage('Review must be at least 50 characters long', 'error');
      return;
    }

    // Check reCAPTCHA
    const recaptchaResponse = grecaptcha.getResponse();
    if (!recaptchaResponse) {
      showMessage('Please complete the reCAPTCHA verification', 'error');
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';

    try {
      const response = await fetch('/api/reviews/submit', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          dispensaryId,
          authorName: document.getElementById('author-name').value,
          authorEmail: document.getElementById('author-email').value || null,
          rating: selectedRating,
          reviewText: reviewText.value,
          recaptchaToken: recaptchaResponse
        })
      });

      const data = await response.json();

      if (response.ok) {
        showMessage('Review submitted successfully! It will appear shortly.', 'success');
        form.reset();
        selectedRating = 0;
        starButtons.forEach(star => {
          star.classList.remove('text-yellow-400');
          star.classList.add('text-gray-300');
        });

        // Reload reviews after 2 seconds
        setTimeout(() => {
          location.reload();
        }, 2000);
      } else {
        showMessage(data.error || 'Failed to submit review', 'error');
      }
    } catch (error) {
      showMessage('Network error. Please try again.', 'error');
      console.error('Error submitting review:', error);
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit Review';
    }
  });

  function showMessage(text, type) {
    messageDiv.textContent = text;
    messageDiv.className = type === 'success'
      ? 'p-4 bg-green-100 border border-green-400 text-green-800 rounded-lg'
      : 'p-4 bg-red-100 border border-red-400 text-red-800 rounded-lg';
    messageDiv.classList.remove('hidden');

    setTimeout(() => {
      messageDiv.classList.add('hidden');
    }, 5000);
  }
})();
</script>
