<%
  // Fix: Handle both ranking objects (dispensary_id) and direct dispensary objects (id)
  // v2 - force redeploy
  const actualDispensaryId = dispensary.dispensary_id || dispensary.id;
  console.log('Vote widget: id=' + dispensary.id + ', dispensary_id=' + dispensary.dispensary_id + ', using=' + actualDispensaryId);
%>
<!-- DEBUG: id=<%= dispensary.id %> dispensary_id=<%= dispensary.dispensary_id %> actualId=<%= actualDispensaryId %> -->
<div class="vote-widget inline-flex items-center gap-2 bg-white rounded-lg shadow border border-gray-200 p-2"
     data-dispensary-id="<%= actualDispensaryId %>">
  <button onclick="vote(<%= actualDispensaryId %>, 1)"
          class="upvote-btn px-3 py-2 rounded hover:bg-green-50 transition <%= canVote ? '' : 'opacity-50 cursor-not-allowed' %>"
          <%= canVote ? '' : 'disabled' %>>
    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
    </svg>
  </button>

  <div class="text-center min-w-[60px]">
    <div class="vote-count font-bold text-lg" id="vote-count-<%= actualDispensaryId %>">
      <%= votes.net_votes || 0 %>
    </div>
    <div class="text-xs text-gray-500">votes</div>
  </div>

  <button onclick="vote(<%= actualDispensaryId %>, -1)"
          class="downvote-btn px-3 py-2 rounded hover:bg-red-50 transition <%= canVote ? '' : 'opacity-50 cursor-not-allowed' %>"
          <%= canVote ? '' : 'disabled' %>>
    <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
    </svg>
  </button>
</div>

<% if (typeof recentVotes !== 'undefined' && recentVotes > 0) { %>
  <div class="text-xs text-gray-500 mt-1">
    <%= recentVotes %> people voted this week
  </div>
<% } %>

<script>
async function vote(dispensaryId, voteType) {
  console.log('Voting for dispensary ID:', dispensaryId, 'voteType:', voteType);
  try {
    const response = await fetch('/api/vote', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ dispensaryId, voteType })
    });

    const data = await response.json();
    console.log('Vote response:', data);

    if (data.success) {
      // Update vote count
      const countEl = document.getElementById('vote-count-' + dispensaryId);
      countEl.textContent = data.voteCounts.net_votes;

      // Disable buttons
      const widget = document.querySelector('[data-dispensary-id="' + dispensaryId + '"]');
      widget.querySelectorAll('button').forEach(btn => {
        btn.disabled = true;
        btn.classList.add('opacity-50', 'cursor-not-allowed');
      });

      // Show success message
      alert('Vote recorded! Thanks for your input.');
    } else {
      console.error('Vote failed:', data.message, 'dispensaryId:', dispensaryId);
      alert(data.message || 'Unable to vote at this time.');
    }
  } catch (error) {
    console.error('Error voting:', error);
    alert('Error processing vote. Please try again.');
  }
}
</script>
