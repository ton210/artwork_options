<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <%- include('partials/favicon') %>
  <%- include('partials/analytics') %>
  <title><%= title %></title>
  <meta name="description" content="<%= meta.description %>">
  <meta name="keywords" content="<%= meta.keywords %>">

  <!-- Open Graph / Social Media -->
  <meta property="og:title" content="<%= title %>">
  <meta property="og:description" content="<%= meta.description %>">
  <meta property="og:type" content="website">
  <meta property="og:url" content="<%= canonicalUrl %>">

  <!-- Canonical URL -->
  <link rel="canonical" href="<%= canonicalUrl %>">

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>body { font-family: 'Inter', sans-serif; }</style>

  <!-- Schema.org Structured Data -->
  <script type="application/ld+json">
    <%- JSON.stringify(schemas.itemList) %>
  </script>
  <script type="application/ld+json">
    <%- JSON.stringify(schemas.breadcrumb) %>
  </script>
</head>
<body class="bg-gray-50">
  <%- include('partials/header') %>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Breadcrumb -->
    <nav class="mb-6 text-sm text-gray-600">
      <a href="/" class="hover:text-green-600">Home</a>
      <span class="mx-2">/</span>
      <a href="/dispensaries/<%= state.slug %>" class="hover:text-green-600"><%= state.name %></a>
      <span class="mx-2">/</span>
      <span class="text-gray-900"><%= cityName %></span>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Main Content -->
      <div class="lg:col-span-2">
        <!-- Header -->
        <div class="mb-6">
          <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
            Best Dispensaries in <%= cityName %>, <%= state.abbreviation %> (2026)
          </h1>
          <p class="text-lg text-gray-600">
            Top <%= dispensaries.length %> cannabis dispensaries in <%= cityName %>, <%= state.name %>, ranked by customer reviews and ratings.
          </p>
        </div>

        <div class="flex flex-wrap items-center gap-4 mb-8 text-gray-600">
          <div class="flex items-center gap-1">
            <span>Updated</span>
            <span class="font-medium"><%= new Date().toLocaleDateString() %></span>
          </div>
          <div class="hidden sm:block">|</div>
          <div class="flex items-center gap-1">
            <span><%= dispensaries.length %></span>
            <span>dispensaries</span>
          </div>
          <% if (avgRating) { %>
            <div class="hidden sm:block">|</div>
            <div class="flex items-center gap-1">
              <span class="text-yellow-500">*</span>
              <span><%= avgRating %> avg rating</span>
            </div>
          <% } %>
        </div>

        <!-- Rankings -->
        <div class="space-y-4 mb-12">
          <% dispensaries.forEach((dispensary, index) => { %>
            <div class="bg-white rounded-lg shadow-md border border-gray-200 p-4 md:p-6 hover:shadow-lg transition">
              <div class="flex flex-col sm:flex-row items-start gap-4">
                <!-- Rank -->
                <div class="flex-shrink-0 text-center sm:text-left">
                  <div class="text-2xl md:text-3xl font-bold text-gray-400">#<%= index + 1 %></div>
                  <% if (index === 0) { %>
                    <div class="text-xl md:text-2xl">*</div>
                  <% } else if (index === 1) { %>
                    <div class="text-xl md:text-2xl">*</div>
                  <% } else if (index === 2) { %>
                    <div class="text-xl md:text-2xl">*</div>
                  <% } %>
                </div>

                <!-- Logo -->
                <% if (dispensary.logo_url) { %>
                  <img src="<%= dispensary.logo_url %>" alt="<%= dispensary.name %>" class="w-16 h-16 md:w-20 md:h-20 object-cover rounded-lg flex-shrink-0">
                <% } %>

                <!-- Details -->
                <div class="flex-grow w-full">
                  <h2 class="text-lg md:text-xl font-bold text-gray-900 mb-2">
                    <a href="/dispensary/<%= dispensary.slug %>" class="hover:text-green-600">
                      <%= dispensary.name %>
                    </a>
                  </h2>

                  <div class="text-gray-600 mb-3 text-sm md:text-base">
                    <div class="flex items-start gap-1">
                      <span>Location:</span>
                      <span><%= dispensary.address_street %>, <%= dispensary.city %></span>
                    </div>
                    <% if (dispensary.phone) { %>
                      <div class="flex items-start gap-1">
                        <span>Phone:</span>
                        <span><%= dispensary.phone %></span>
                      </div>
                    <% } %>
                  </div>

                  <div class="flex flex-wrap items-center gap-2 md:gap-4 mb-3">
                    <div class="flex items-center gap-1">
                      <span class="text-yellow-500">*</span>
                      <span class="font-semibold"><%= dispensary.google_rating || 'N/A' %></span>
                      <span class="text-gray-500 text-sm">(<%= dispensary.google_review_count || 0 %> reviews)</span>
                    </div>
                  </div>

                  <div class="flex items-center gap-4">
                    <a href="/dispensary/<%= dispensary.slug %>"
                       class="text-green-600 hover:text-green-700 font-medium text-sm md:text-base">
                      View Details
                    </a>
                    <% if (dispensary.website) { %>
                      <a href="<%= dispensary.website %>" target="_blank" rel="nofollow noopener"
                         class="text-blue-600 hover:text-blue-700 font-medium text-sm md:text-base">
                        Visit Website
                      </a>
                    <% } %>
                  </div>
                </div>
              </div>
            </div>

            <!-- Ad after #3 -->
            <% if (index === 2) { %>
              <div class="bg-green-50 border-2 border-green-200 rounded-lg p-4 md:p-6 text-center">
                <div class="text-2xl mb-2">*</div>
                <h3 class="text-lg md:text-xl font-bold text-gray-900 mb-2">
                  Want your dispensary's brand on custom accessories?
                </h3>
                <p class="text-gray-600 mb-4 text-sm md:text-base">
                  Partner with MunchMakers for premium branded grinders, trays, and more
                </p>
                <a href="<%= MUNCHMAKERS_URL %>" target="_blank"
                   class="inline-block bg-green-600 text-white font-bold px-4 md:px-6 py-2 md:py-3 rounded-lg hover:bg-green-700 text-sm md:text-base">
                  Get Wholesale Quote
                </a>
              </div>
            <% } %>
          <% }); %>
        </div>

        <!-- Other Cities -->
        <% if (otherCities && otherCities.length > 0) { %>
          <div class="bg-white rounded-lg shadow p-4 md:p-6 mb-8">
            <h2 class="text-xl md:text-2xl font-bold mb-4">Other Cities in <%= state.name %></h2>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-2 md:gap-3">
              <% otherCities.forEach(c => { %>
                <% const slug = c.city.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, ''); %>
                <a href="/dispensaries/<%= state.slug %>/city/<%= slug %>"
                   class="block p-2 md:p-3 bg-gray-50 rounded hover:bg-green-50 hover:text-green-600 transition text-sm md:text-base">
                  <div class="font-semibold"><%= c.city %></div>
                  <div class="text-xs md:text-sm text-gray-500"><%= c.count %> dispensaries</div>
                </a>
              <% }); %>
            </div>
          </div>
        <% } %>

        <!-- About Section -->
        <div class="bg-white rounded-lg shadow p-4 md:p-6 mb-8">
          <h2 class="text-xl md:text-2xl font-bold mb-4">About Dispensaries in <%= cityName %>, <%= state.abbreviation %></h2>
          <div class="prose max-w-none text-gray-700 space-y-4 text-sm md:text-base">
            <p>
              Looking for the best cannabis dispensaries in <%= cityName %>, <%= state.name %>?
              Our comprehensive directory ranks <%= dispensaries.length %> dispensaries in <%= cityName %>, based on real customer reviews, ratings, and community feedback.
            </p>
            <p>
              These top-rated dispensaries offer a wide selection of cannabis products including flower, edibles, vapes, concentrates, and more.
              Many locations also offer online ordering, delivery, and curbside pickup for added convenience.
            </p>
          </div>
        </div>

        <!-- FAQ Section -->
        <div class="bg-white rounded-lg shadow p-4 md:p-6 mb-8">
          <h2 class="text-xl md:text-2xl font-bold mb-6">Frequently Asked Questions</h2>
          <div class="space-y-6 text-sm md:text-base">
            <div>
              <h3 class="font-bold text-base md:text-lg mb-2">What are the best dispensaries in <%= cityName %>, <%= state.abbreviation %>?</h3>
              <p class="text-gray-700">
                Based on customer reviews and ratings, the top dispensaries in <%= cityName %> are
                <% dispensaries.slice(0, 3).forEach((d, i) => { %>
                  <%= d.name %><% if (i < Math.min(dispensaries.length, 3) - 2) { %>, <% } else if (i < Math.min(dispensaries.length, 3) - 1) { %> and <% } %>
                <% }); %>.
              </p>
            </div>

            <div>
              <h3 class="font-bold text-base md:text-lg mb-2">How many dispensaries are in <%= cityName %>?</h3>
              <p class="text-gray-700">
                There are <%= dispensaries.length %> cannabis dispensaries in <%= cityName %>, <%= state.abbreviation %>.
                Browse our complete list above to find the best option near you.
              </p>
            </div>

            <div>
              <h3 class="font-bold text-base md:text-lg mb-2">Do I need a medical card to buy cannabis in <%= cityName %>?</h3>
              <p class="text-gray-700">
                Requirements vary by location. Some dispensaries are recreational-only (21+), while others serve medical patients.
                Check individual dispensary listings for specific requirements, or contact the dispensary directly.
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="lg:col-span-1">
        <%- include('partials/munchmakersAd') %>
      </div>
    </div>
  </div>

  <%- include('partials/footer') %>
</body>
</html>
