<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <%- include('partials/favicon') %>
  <%- include('partials/analytics') %>
  <title><%= title %></title>
  <meta name="description" content="<%= meta.description %>">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>body { font-family: 'Inter', sans-serif; }</style>
</head>
<body class="bg-gray-50">
  <%- include('partials/header') %>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Breadcrumb -->
    <nav class="mb-6 text-sm text-gray-600">
      <a href="/" class="hover:text-green-600">Home</a>
      <span class="mx-2">/</span>
      <span class="text-gray-900"><%= state.name %></span>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Main Content -->
      <div class="lg:col-span-2">
        <!-- Header -->
        <div class="flex justify-between items-start mb-4">
          <h1 class="text-4xl font-bold text-gray-900">
            <% if (showAll) { %>
              All <%= rankings.length %> Dispensaries in <%= state.name %>
            <% } else { %>
              Top 10 Dispensaries in <%= state.name %> (2026)
            <% } %>
          </h1>
          <% if (!showAll && stats.dispensary_count > 10) { %>
            <a href="?view=all" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-semibold whitespace-nowrap">
              View All <%= stats.dispensary_count %> â†’
            </a>
          <% } %>
        </div>

        <div class="flex items-center gap-4 mb-8 text-gray-600">
          <div>ğŸ“… Updated <%= new Date().toLocaleDateString() %></div>
          <div>â€¢</div>
          <div>ğŸ“Š <%= stats.dispensary_count || 0 %> dispensaries</div>
          <div>â€¢</div>
          <div>â­ <%= Number(stats.avg_rating || 0).toFixed(1) %> avg rating</div>
        </div>

        <% if (showAll) { %>
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <p class="text-sm">
              <a href="?" class="text-blue-600 hover:underline">â† Back to Top 10</a>
              <span class="mx-2">â€¢</span>
              Showing all <%= rankings.length %> dispensaries ranked by rating and reviews
            </p>
          </div>
        <% } %>

        <!-- Rankings -->
        <div class="space-y-4 mb-12">
          <% rankings.forEach((dispensary, index) => { %>
            <div class="bg-white rounded-lg shadow-md border border-gray-200 p-6 hover:shadow-lg transition">
              <div class="flex items-start gap-4">
                <!-- Rank -->
                <div class="flex-shrink-0 text-center">
                  <div class="text-3xl font-bold text-gray-400">#<%= dispensary.rank %></div>
                  <% if (index === 0) { %>
                    <div class="text-2xl">ğŸ¥‡</div>
                  <% } else if (index === 1) { %>
                    <div class="text-2xl">ğŸ¥ˆ</div>
                  <% } else if (index === 2) { %>
                    <div class="text-2xl">ğŸ¥‰</div>
                  <% } %>
                </div>

                <!-- Logo -->
                <% if (dispensary.logo_url) { %>
                  <img src="<%= dispensary.logo_url %>" alt="<%= dispensary.name %>" class="w-20 h-20 object-cover rounded-lg flex-shrink-0">
                <% } %>

                <!-- Details -->
                <div class="flex-grow">
                  <h3 class="text-xl font-bold text-gray-900 mb-2">
                    <a href="/dispensary/<%= dispensary.slug %>" class="hover:text-green-600">
                      <%= dispensary.name %>
                    </a>
                  </h3>

                  <div class="text-gray-600 mb-3">
                    <div>ğŸ“ <%= dispensary.address_street %>, <%= dispensary.city %></div>
                    <% if (dispensary.phone) { %>
                      <div>ğŸ“ <%= dispensary.phone %></div>
                    <% } %>
                  </div>

                  <div class="flex items-center gap-4 mb-3">
                    <div class="flex items-center gap-1">
                      <span class="text-yellow-500">â­</span>
                      <span class="font-semibold"><%= dispensary.google_rating || 'N/A' %></span>
                      <span class="text-gray-500 text-sm">(<%= dispensary.google_review_count || 0 %> reviews)</span>
                    </div>
                    <div class="text-green-600 font-semibold">
                      Score: <%= dispensary.composite_score %>
                    </div>
                  </div>

                  <div class="flex items-center gap-4">
                    <%- include('partials/voteWidget', {
                      dispensary: dispensary,
                      votes: dispensary.votes,
                      recentVotes: dispensary.recentVotes,
                      canVote: dispensary.canVote
                    }) %>

                    <a href="/dispensary/<%= dispensary.slug %>"
                       class="text-green-600 hover:text-green-700 font-medium">
                      View Details â†’
                    </a>
                  </div>
                </div>
              </div>
            </div>

            <!-- Ad after #3 -->
            <% if (index === 2) { %>
              <div class="bg-green-50 border-2 border-green-200 rounded-lg p-6 text-center">
                <div class="text-2xl mb-2">ğŸ†</div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">
                  Want your dispensary's brand on custom accessories?
                </h3>
                <p class="text-gray-600 mb-4">
                  Partner with MunchMakers for premium branded grinders, trays, and more
                </p>
                <a href="<%= MUNCHMAKERS_URL %>" target="_blank"
                   class="inline-block bg-green-600 text-white font-bold px-6 py-3 rounded-lg hover:bg-green-700">
                  Get Wholesale Quote
                </a>
              </div>
            <% } %>
          <% }); %>
        </div>

        <!-- Browse by Category -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
          <h2 class="text-2xl font-bold mb-4">Best Dispensaries by Category</h2>
          <p class="text-gray-600 mb-4">Find top-rated dispensaries in <%= state.name %> specializing in:</p>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
            <a href="/dispensaries/<%= state.slug %>/best-edibles" class="block p-3 bg-green-50 rounded hover:bg-green-100 hover:text-green-700 transition">
              <div class="font-semibold">Best Edibles</div>
            </a>
            <a href="/dispensaries/<%= state.slug %>/best-flower" class="block p-3 bg-green-50 rounded hover:bg-green-100 hover:text-green-700 transition">
              <div class="font-semibold">Best Flower</div>
            </a>
            <a href="/dispensaries/<%= state.slug %>/best-vapes" class="block p-3 bg-green-50 rounded hover:bg-green-100 hover:text-green-700 transition">
              <div class="font-semibold">Best Vapes</div>
            </a>
            <a href="/dispensaries/<%= state.slug %>/best-concentrates" class="block p-3 bg-green-50 rounded hover:bg-green-100 hover:text-green-700 transition">
              <div class="font-semibold">Best Concentrates</div>
            </a>
            <a href="/dispensaries/<%= state.slug %>/best-pre-rolls" class="block p-3 bg-green-50 rounded hover:bg-green-100 hover:text-green-700 transition">
              <div class="font-semibold">Best Pre-Rolls</div>
            </a>
            <a href="/dispensaries/<%= state.slug %>/best-delivery" class="block p-3 bg-green-50 rounded hover:bg-green-100 hover:text-green-700 transition">
              <div class="font-semibold">Best Delivery</div>
            </a>
          </div>
        </div>

        <!-- Counties in State -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
          <h2 class="text-2xl font-bold mb-4">Browse by County</h2>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
            <% counties.forEach(county => { %>
              <a href="/dispensaries/<%= state.slug %>/<%= county.slug %>"
                 class="block p-3 bg-gray-50 rounded hover:bg-green-50 hover:text-green-600 transition">
                <div class="font-semibold"><%= county.name %></div>
                <div class="text-sm text-gray-500"><%= county.dispensary_count || 0 %> dispensaries</div>
              </a>
            <% }); %>
          </div>
        </div>

        <!-- About Cannabis in State -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
          <h2 class="text-2xl font-bold mb-4">About Cannabis Dispensaries in <%= state.name %></h2>
          <div class="prose max-w-none text-gray-700 space-y-4">
            <p>
              <%= state.name %> is home to <%= stats.dispensary_count || 0 %> licensed cannabis dispensaries serving both medical
              and recreational customers. Our comprehensive directory helps you discover the highest-rated dispensaries
              based on real customer reviews, ratings, and community feedback.
            </p>
            <p>
              The dispensaries in <%= state.name %> offer a wide variety of cannabis products including flower, concentrates,
              edibles, tinctures, topicals, and pre-rolls. Many locations also provide delivery services, online ordering,
              and curbside pickup for added convenience.
            </p>
            <p>
              Our rankings combine multiple factors including Google ratings (25% weight), review volume (15%),
              external platform listings (10%), user votes (20%), page views (10%), data completeness (10%),
              and engagement metrics (10%) to give you the most accurate assessment of quality dispensaries in <%= state.name %>.
            </p>
          </div>
        </div>

        <!-- FAQ Section -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
          <h2 class="text-2xl font-bold mb-6">Frequently Asked Questions</h2>
          <div class="space-y-6">
            <div>
              <h3 class="font-bold text-lg mb-2">How are dispensaries ranked in <%= state.name %>?</h3>
              <p class="text-gray-700">
                Dispensaries are ranked using our 7-factor weighted algorithm that considers Google ratings (25%),
                review volume (15%), external listings on platforms like Leafly and Weedmaps (10%), user votes (20%),
                page views (10%), data completeness (10%), and user engagement (10%). This ensures the most reputable
                and popular dispensaries rise to the top.
              </p>
            </div>

            <div>
              <h3 class="font-bold text-lg mb-2">What should I look for when choosing a dispensary?</h3>
              <p class="text-gray-700">
                Consider factors like customer reviews, product variety, pricing, location convenience, staff knowledge,
                store cleanliness, and available deals or loyalty programs. Our rankings help identify dispensaries that
                excel in these areas based on real customer feedback.
              </p>
            </div>

            <div>
              <h3 class="font-bold text-lg mb-2">Do I need a medical card to visit dispensaries in <%= state.name %>?</h3>
              <p class="text-gray-700">
                Requirements vary by state. <%= state.name %> may have both medical and recreational dispensaries.
                Check individual dispensary listings for their specific requirements. Most recreational dispensaries
                only require a valid ID showing you're 21+.
              </p>
            </div>

            <div>
              <h3 class="font-bold text-lg mb-2">How can I find dispensaries near me in <%= state.name %>?</h3>
              <p class="text-gray-700">
                Use our <a href="/near-me" class="text-green-600 hover:underline font-semibold">"Near Me" search feature</a>
                to find dispensaries within 5-100 miles of your current location. You can also browse by county above to
                narrow down your search to specific regions within <%= state.name %>.
              </p>
            </div>

            <div>
              <h3 class="font-bold text-lg mb-2">Can dispensary owners claim their listing?</h3>
              <p class="text-gray-700">
                Yes! Dispensary owners can <a href="/claim" class="text-green-600 hover:underline font-semibold">claim their listing</a>
                to update information, respond to reviews, and access analytics. If your email domain matches your dispensary's
                website, you'll be automatically verified.
              </p>
            </div>
          </div>
        </div>

        <!-- Buying Guide -->
        <div class="bg-gradient-to-br from-green-50 to-blue-50 rounded-lg shadow p-6 mb-8">
          <h2 class="text-2xl font-bold mb-4">First-Time Dispensary Visitor? Here's What to Know</h2>
          <div class="space-y-3 text-gray-700">
            <div class="flex items-start gap-3">
              <span class="text-2xl">ğŸ†”</span>
              <div>
                <strong>Bring Valid ID:</strong> All visitors must be 21+ and show government-issued identification.
                Medical patients should bring their medical card.
              </div>
            </div>
            <div class="flex items-start gap-3">
              <span class="text-2xl">ğŸ’°</span>
              <div>
                <strong>Payment Methods:</strong> Many dispensaries are cash-only or accept debit cards. ATMs are typically available on-site.
              </div>
            </div>
            <div class="flex items-start gap-3">
              <span class="text-2xl">ğŸ“±</span>
              <div>
                <strong>Check Menus Online:</strong> Most dispensaries post their product menus online. Browse before visiting to save time.
              </div>
            </div>
            <div class="flex items-start gap-3">
              <span class="text-2xl">ğŸ“</span>
              <div>
                <strong>Ask Questions:</strong> Budtenders are knowledgeable and happy to help you find the right products for your needs.
              </div>
            </div>
            <div class="flex items-start gap-3">
              <span class="text-2xl">âš–ï¸</span>
              <div>
                <strong>Know Purchase Limits:</strong> <%= state.name %> has legal limits on how much cannabis you can purchase per transaction.
                Ask staff if you're unsure.
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="lg:col-span-1">
        <%- include('partials/munchmakersAd') %>
      </div>
    </div>
  </div>

  <%- include('partials/footer') %>
</body>
</html>
