<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <%- include('partials/favicon') %>
  <%- include('partials/analytics') %>
  <title><%= title %></title>
  <meta name="description" content="<%= meta.description %>">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>body { font-family: 'Inter', sans-serif; }</style>
</head>
<body class="bg-gray-50">
  <%- include('partials/header') %>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Breadcrumb -->
    <nav class="mb-6 text-sm text-gray-600">
      <a href="/" class="hover:text-green-600">Home</a>
      <span class="mx-2">/</span>
      <span class="text-gray-900"><%= state.name %></span>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Main Content -->
      <div class="lg:col-span-2">
        <!-- Header -->
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-4 mb-4">
          <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-gray-900">
            <% if (showAll) { %>
              All <%= rankings.length %> Dispensaries in <%= state.name %>
            <% } else { %>
              Top 10 Dispensaries in <%= state.name %> (2026)
            <% } %>
          </h1>
          <% if (!showAll && stats.dispensary_count > 10) { %>
            <a href="?view=all" class="bg-green-600 text-white px-4 sm:px-6 py-2 sm:py-3 rounded-lg hover:bg-green-700 transition font-semibold whitespace-nowrap text-center text-sm sm:text-base">
              View All <%= stats.dispensary_count %> ‚Üí
            </a>
          <% } %>
        </div>

        <div class="flex flex-wrap items-center gap-2 sm:gap-4 mb-8 text-gray-600 text-sm sm:text-base">
          <div>Updated <%= new Date().toLocaleDateString() %></div>
          <div class="hidden sm:block">‚Ä¢</div>
          <div><%= stats.dispensary_count || 0 %> dispensaries</div>
          <div class="hidden sm:block">‚Ä¢</div>
          <div><%= Number(stats.avg_rating || 0).toFixed(1) %> avg rating</div>
        </div>

        <!-- Location Stats Banner -->
        <% if (locationStats && (locationStats.viewsToday > 0 || locationStats.viewsWeek > 0)) { %>
          <div class="bg-gradient-to-r from-blue-50 to-green-50 border border-blue-200 rounded-lg p-4 mb-6">
            <div class="flex flex-wrap items-center gap-4 text-sm">
              <div class="flex items-center gap-2">
                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                </svg>
                <span class="font-semibold text-gray-700">Live Activity:</span>
              </div>
              <% if (locationStats.viewsToday > 0) { %>
                <div class="text-gray-700">
                  <span class="font-bold text-green-700"><%= locationStats.viewsToday %></span>
                  <span>visitors today</span>
                </div>
              <% } %>
              <% if (locationStats.viewsWeek > 0) { %>
                <div class="text-gray-700">
                  <span class="font-bold text-blue-700"><%= locationStats.viewsWeek %></span>
                  <span>this week</span>
                </div>
              <% } %>
              <% if (locationStats.activeToday > 0) { %>
                <div class="text-gray-700">
                  <span class="font-bold text-purple-700"><%= locationStats.activeToday %></span>
                  <span>dispensaries viewed today</span>
                </div>
              <% } %>
            </div>
          </div>
        <% } %>

        <% if (showAll) { %>
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <p class="text-sm">
              <a href="?" class="text-blue-600 hover:underline">‚Üê Back to Top 10</a>
              <span class="mx-2">‚Ä¢</span>
              Showing all <%= rankings.length %> dispensaries ranked by rating and reviews
            </p>
          </div>
        <% } %>

        <!-- Rankings -->
        <div class="space-y-4 mb-12">
          <% rankings.forEach((dispensary, index) => { %>
            <div class="bg-white rounded-lg shadow-md border border-gray-200 p-4 sm:p-6 hover:shadow-lg transition">
              <div class="flex flex-col sm:flex-row items-start gap-3 sm:gap-4">
                <!-- Rank and Logo row on mobile -->
                <div class="flex items-center gap-3 sm:contents w-full sm:w-auto">
                  <!-- Rank -->
                  <div class="flex-shrink-0 text-center">
                    <div class="text-2xl sm:text-3xl font-bold text-gray-400">#<%= dispensary.rank %></div>
                    <% if (index === 0) { %>
                      <div class="text-xl sm:text-2xl">ü•á</div>
                    <% } else if (index === 1) { %>
                      <div class="text-xl sm:text-2xl">ü•à</div>
                    <% } else if (index === 2) { %>
                      <div class="text-xl sm:text-2xl">ü•â</div>
                    <% } %>
                  </div>

                  <!-- Logo -->
                  <% if (dispensary.logo_url) { %>
                    <img src="<%= dispensary.logo_url %>" alt="<%= dispensary.name %>" class="w-16 h-16 sm:w-20 sm:h-20 object-cover rounded-lg flex-shrink-0">
                  <% } %>

                  <!-- Name on mobile only -->
                  <h3 class="text-lg font-bold text-gray-900 sm:hidden flex-1">
                    <a href="/dispensary/<%= dispensary.slug %>" class="hover:text-green-600">
                      <%= dispensary.name %>
                    </a>
                  </h3>
                </div>

                <!-- Details -->
                <div class="flex-grow w-full">
                  <!-- Name on desktop -->
                  <h3 class="hidden sm:block text-xl font-bold text-gray-900 mb-2">
                    <a href="/dispensary/<%= dispensary.slug %>" class="hover:text-green-600">
                      <%= dispensary.name %>
                    </a>
                  </h3>

                  <div class="text-gray-600 mb-3 text-sm sm:text-base">
                    <div><%= dispensary.address_street %>, <%= dispensary.city %></div>
                    <% if (dispensary.phone) { %>
                      <div><%= dispensary.phone %></div>
                    <% } %>
                  </div>

                  <div class="flex flex-wrap items-center gap-2 sm:gap-4 mb-3 text-sm sm:text-base">
                    <div class="flex items-center gap-1">
                      <span class="text-yellow-500">‚òÖ</span>
                      <span class="font-semibold"><%= dispensary.google_rating || 'N/A' %></span>
                      <span class="text-gray-500 text-xs sm:text-sm">(<%= dispensary.google_review_count || 0 %>)</span>
                    </div>
                    <div class="text-green-600 font-semibold">
                      Score: <%= dispensary.composite_score %>
                    </div>
                  </div>

                  <!-- Social Proof Badges -->
                  <%- include('partials/social-proof-badges', { dispensary }) %>

                  <div class="flex flex-wrap items-center gap-3 sm:gap-4 mt-3">
                    <%- include('partials/voteWidget', {
                      dispensary: dispensary,
                      votes: dispensary.votes,
                      recentVotes: dispensary.recentVotes,
                      canVote: dispensary.canVote
                    }) %>

                    <a href="/dispensary/<%= dispensary.slug %>"
                       class="text-green-600 hover:text-green-700 font-medium text-sm sm:text-base">
                      View Details ‚Üí
                    </a>
                  </div>
                </div>
              </div>
            </div>

            <!-- Ad after #3 -->
            <% if (index === 2) { %>
              <div class="bg-green-50 border-2 border-green-200 rounded-lg p-4 sm:p-6 text-center">
                <div class="text-xl sm:text-2xl mb-2">üèÜ</div>
                <h3 class="text-lg sm:text-xl font-bold text-gray-900 mb-2">
                  Want your dispensary's brand on custom accessories?
                </h3>
                <p class="text-gray-600 mb-4 text-sm sm:text-base">
                  Partner with MunchMakers for premium branded grinders, trays, and more
                </p>
                <a href="<%= MUNCHMAKERS_URL %>" target="_blank"
                   class="inline-block bg-green-600 text-white font-bold px-4 sm:px-6 py-2 sm:py-3 rounded-lg hover:bg-green-700 text-sm sm:text-base">
                  Get Wholesale Quote
                </a>
              </div>
            <% } %>
          <% }); %>
        </div>

        <!-- Browse by Category -->
        <% if (availableTags && availableTags.length > 0) { %>
        <div class="bg-white rounded-lg shadow p-4 sm:p-6 mb-8">
          <h2 class="text-xl sm:text-2xl font-bold mb-4">Best Dispensaries by Category</h2>
          <p class="text-gray-600 mb-4 text-sm sm:text-base">Find top-rated dispensaries in <%= state.name %> specializing in:</p>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-2 sm:gap-3">
            <% availableTags.forEach(tag => { %>
            <a href="/dispensaries/<%= state.slug %>/best-<%= tag.slug %>" class="block p-2 sm:p-3 bg-green-50 rounded hover:bg-green-100 hover:text-green-700 transition">
              <div class="font-semibold text-sm sm:text-base">Best <%= tag.display %></div>
            </a>
            <% }); %>
          </div>
        </div>
        <% } %>

        <!-- Counties in State -->
        <div class="bg-white rounded-lg shadow p-4 sm:p-6 mb-8">
          <h2 class="text-xl sm:text-2xl font-bold mb-4">Browse by County</h2>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-2 sm:gap-3">
            <% counties.forEach(county => { %>
              <a href="/dispensaries/<%= state.slug %>/<%= county.slug %>"
                 class="block p-2 sm:p-3 bg-gray-50 rounded hover:bg-green-50 hover:text-green-600 transition">
                <div class="font-semibold text-sm sm:text-base"><%= county.name %></div>
                <div class="text-xs sm:text-sm text-gray-500"><%= county.dispensary_count || 0 %> dispensaries</div>
              </a>
            <% }); %>
          </div>
        </div>

        <% if (stateDetails) { %>
        <!-- Cannabis Laws & Regulations -->
        <div class="bg-gradient-to-br from-green-50 to-blue-50 rounded-lg shadow-lg p-4 sm:p-6 mb-8">
          <h2 class="text-xl sm:text-2xl font-bold mb-4 text-gray-900">
            Cannabis Laws in <%= state.name %>
          </h2>
          <div class="prose max-w-none text-gray-700 space-y-4 text-sm sm:text-base">
            <p class="text-base sm:text-lg font-semibold text-green-800">
              <span class="inline-block px-3 py-1 bg-green-100 rounded-full text-sm mr-2">
                <%= stateDetails.legalStatus %>
              </span>
              <% if (stateDetails.legalStatus.includes('Recreational')) { %>
                Legalized for recreational use <%= stateDetails.recreationalLegalizedYear ? 'in ' + stateDetails.recreationalLegalizedYear : '' %>
              <% } else { %>
                Medical marijuana only <%= stateDetails.medicalLegalizedYear ? '(legalized ' + stateDetails.medicalLegalizedYear + ')' : '' %>
              <% } %>
            </p>

            <p><%= stateDetails.description %></p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
              <div class="bg-white rounded-lg p-4">
                <h3 class="font-bold text-gray-900 mb-2 flex items-center">
                  <span class="text-lg mr-2">üõí</span>
                  Purchase Limits
                </h3>
                <p class="text-sm text-gray-700"><%= stateDetails.purchaseLimits %></p>
              </div>

              <div class="bg-white rounded-lg p-4">
                <h3 class="font-bold text-gray-900 mb-2 flex items-center">
                  <span class="text-lg mr-2">üëú</span>
                  Possession Limits
                </h3>
                <p class="text-sm text-gray-700"><%= stateDetails.possessionLimits %></p>
              </div>

              <div class="bg-white rounded-lg p-4">
                <h3 class="font-bold text-gray-900 mb-2 flex items-center">
                  <span class="text-lg mr-2">üå±</span>
                  Home Cultivation
                </h3>
                <p class="text-sm text-gray-700">
                  <% if (stateDetails.homegrowAllowed) { %>
                    <span class="text-green-600 font-semibold">Allowed</span>
                    <%= stateDetails.homegrowLimit ? ' - ' + stateDetails.homegrowLimit : '' %>
                  <% } else { %>
                    <span class="text-red-600 font-semibold">Not Permitted</span>
                  <% } %>
                </p>
              </div>

              <div class="bg-white rounded-lg p-4">
                <h3 class="font-bold text-gray-900 mb-2 flex items-center">
                  <span class="text-lg mr-2">üéÇ</span>
                  Age Requirement
                </h3>
                <p class="text-sm text-gray-700"><%= stateDetails.ageRequirement %></p>
              </div>
            </div>

            <% if (stateDetails.qualifyingConditions && stateDetails.qualifyingConditions.length > 0) { %>
            <div class="bg-white rounded-lg p-4 mt-4">
              <h3 class="font-bold text-gray-900 mb-2 flex items-center">
                <span class="text-lg mr-2">‚öïÔ∏è</span>
                Qualifying Medical Conditions
              </h3>
              <p class="text-sm text-gray-700 mb-2">Medical marijuana patients with the following conditions may access cannabis in <%= state.name %>:</p>
              <div class="flex flex-wrap gap-2 mt-2">
                <% stateDetails.qualifyingConditions.forEach(condition => { %>
                  <span class="inline-block px-3 py-1 bg-blue-50 text-blue-700 rounded-full text-xs">
                    <%= condition %>
                  </span>
                <% }); %>
              </div>
            </div>
            <% } %>

            <div class="bg-white rounded-lg p-4 mt-4">
              <h3 class="font-bold text-gray-900 mb-2 flex items-center">
                <span class="text-lg mr-2">üìç</span>
                Where You Can Consume
              </h3>
              <p class="text-sm text-gray-700"><%= stateDetails.consumptionRules %></p>
            </div>

            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mt-4">
              <p class="text-xs text-yellow-800">
                <strong>Important:</strong> Laws are subject to change. Always verify current regulations with official state sources.
                Cannabis remains illegal under federal law.
              </p>
            </div>
          </div>
        </div>
        <% } %>

        <!-- About Cannabis in State -->
        <div class="bg-white rounded-lg shadow p-4 sm:p-6 mb-8">
          <h2 class="text-xl sm:text-2xl font-bold mb-4">About Cannabis Dispensaries in <%= state.name %></h2>
          <div class="prose max-w-none text-gray-700 space-y-4 text-sm sm:text-base">
            <p>
              <%= state.name %> is home to <%= stats.dispensary_count || 0 %> licensed cannabis dispensaries serving both medical
              and recreational customers. Our comprehensive directory helps you discover the highest-rated dispensaries
              based on real customer reviews, ratings, and community feedback.
            </p>
            <p>
              The dispensaries in <%= state.name %> offer a wide variety of cannabis products including flower, concentrates,
              edibles, tinctures, topicals, and pre-rolls. Many locations also provide delivery services, online ordering,
              and curbside pickup for added convenience.
            </p>
            <p>
              Our rankings combine multiple factors including Google ratings (25% weight), review volume (15%),
              external platform listings (10%), user votes (20%), page views (10%), data completeness (10%),
              and engagement metrics (10%) to give you the most accurate assessment of quality dispensaries in <%= state.name %>.
            </p>
          </div>
        </div>

        <!-- FAQ Section -->
        <div class="bg-white rounded-lg shadow p-4 sm:p-6 mb-8">
          <h2 class="text-xl sm:text-2xl font-bold mb-6">Frequently Asked Questions</h2>
          <div class="space-y-6">
            <div>
              <h3 class="font-bold text-base sm:text-lg mb-2">How are dispensaries ranked in <%= state.name %>?</h3>
              <p class="text-gray-700 text-sm sm:text-base">
                Dispensaries are ranked using our 7-factor weighted algorithm that considers Google ratings (25%),
                review volume (15%), external listings on platforms like Leafly and Weedmaps (10%), user votes (20%),
                page views (10%), data completeness (10%), and user engagement (10%). This ensures the most reputable
                and popular dispensaries rise to the top.
              </p>
            </div>

            <div>
              <h3 class="font-bold text-base sm:text-lg mb-2">What should I look for when choosing a dispensary?</h3>
              <p class="text-gray-700 text-sm sm:text-base">
                Consider factors like customer reviews, product variety, pricing, location convenience, staff knowledge,
                store cleanliness, and available deals or loyalty programs. Our rankings help identify dispensaries that
                excel in these areas based on real customer feedback.
              </p>
            </div>

            <div>
              <h3 class="font-bold text-base sm:text-lg mb-2">Do I need a medical card to visit dispensaries in <%= state.name %>?</h3>
              <p class="text-gray-700 text-sm sm:text-base">
                Requirements vary by state. <%= state.name %> may have both medical and recreational dispensaries.
                Check individual dispensary listings for their specific requirements. Most recreational dispensaries
                only require a valid ID showing you're 21+.
              </p>
            </div>

            <div>
              <h3 class="font-bold text-base sm:text-lg mb-2">How can I find dispensaries near me in <%= state.name %>?</h3>
              <p class="text-gray-700 text-sm sm:text-base">
                Use our <a href="/near-me" class="text-green-600 hover:underline font-semibold">"Near Me" search feature</a>
                to find dispensaries within 5-100 miles of your current location. You can also browse by county above to
                narrow down your search to specific regions within <%= state.name %>.
              </p>
            </div>

            <div>
              <h3 class="font-bold text-base sm:text-lg mb-2">Can dispensary owners claim their listing?</h3>
              <p class="text-gray-700 text-sm sm:text-base">
                Yes! Dispensary owners can <a href="/claim" class="text-green-600 hover:underline font-semibold">claim their listing</a>
                to update information, respond to reviews, and access analytics. If your email domain matches your dispensary's
                website, you'll be automatically verified.
              </p>
            </div>
          </div>
        </div>

        <!-- Buying Guide -->
        <div class="bg-gradient-to-br from-green-50 to-blue-50 rounded-lg shadow p-4 sm:p-6 mb-8">
          <h2 class="text-xl sm:text-2xl font-bold mb-4">First-Time Dispensary Visitor? Here's What to Know</h2>
          <div class="space-y-3 text-gray-700 text-sm sm:text-base">
            <div class="flex items-start gap-3">
              <span class="text-xl sm:text-2xl flex-shrink-0">üÜî</span>
              <div>
                <strong>Bring Valid ID:</strong> All visitors must be 21+ and show government-issued identification.
                Medical patients should bring their medical card.
              </div>
            </div>
            <div class="flex items-start gap-3">
              <span class="text-xl sm:text-2xl flex-shrink-0">üí∞</span>
              <div>
                <strong>Payment Methods:</strong> Many dispensaries are cash-only or accept debit cards. ATMs are typically available on-site.
              </div>
            </div>
            <div class="flex items-start gap-3">
              <span class="text-xl sm:text-2xl flex-shrink-0">üì±</span>
              <div>
                <strong>Check Menus Online:</strong> Most dispensaries post their product menus online. Browse before visiting to save time.
              </div>
            </div>
            <div class="flex items-start gap-3">
              <span class="text-xl sm:text-2xl flex-shrink-0">üéì</span>
              <div>
                <strong>Ask Questions:</strong> Budtenders are knowledgeable and happy to help you find the right products for your needs.
              </div>
            </div>
            <div class="flex items-start gap-3">
              <span class="text-xl sm:text-2xl flex-shrink-0">‚öñÔ∏è</span>
              <div>
                <strong>Know Purchase Limits:</strong> <%= state.name %> has legal limits on how much cannabis you can purchase per transaction.
                Ask staff if you're unsure.
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="lg:col-span-1">
        <%- include('partials/munchmakersAd') %>
      </div>
    </div>
  </div>

  <%- include('partials/footer') %>
</body>
</html>
